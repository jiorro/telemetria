<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>F1 25 Telemetria</title>
  <style>
    body {
      margin: 0;
      background: linear-gradient(to bottom, #0f0f0f, #1a1a1a);
      color: #00ffcc;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      text-align: center;
      padding: 30px 0 10px;
    }

    main {
      display: flex;
      flex: 1;
      flex-direction: row;
    }

    .left {
      flex: 2;
      padding: 40px;
    }

    .right {
      flex: 1;
      background-color: #121212;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-left: 2px solid #333;
    }

    form {
      text-align: center;
      margin-bottom: 20px;
    }

    input {
      padding: 8px;
      font-size: 1em;
      border-radius: 5px;
      border: none;
      margin-right: 10px;
      background: #222;
      color: #00ffcc;
    }

    button {
      padding: 8px 16px;
      font-size: 1em;
      background-color: #00ffcc;
      color: #000;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #00ccaa;
    }

    .telemetry {
      font-size: 1.2em;
      margin-top: 20px;
      text-align: center;
    }

    .speed-display {
      font-size: 3em;
      font-weight: bold;
      color: #00ffcc;
    }

    canvas {
      background-color: #222;
      border-radius: 10px;
      max-width: 100%;
    }

    .strategy-section {
      background-color: #181818;
      color: #eee;
      padding: 30px;
      border-top: 2px solid #333;
    }

    .strategy-section h2 {
      color: #00ffcc;
      text-align: center;
    }

    .strategy-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      max-width: 800px;
      margin: 20px auto;
    }

    .strategy-grid p {
      margin: 10px 0;
      font-size: 1.1em;
    }

    .status {
      text-align: center;
      padding: 10px;
      background: #00ffcc;
      color: #000;
      border-radius: 5px;
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>F1 25 Telemetria Live</h1>
    <form id="configForm">
      <input type="text" id="ipInput" value="127.0.0.1" placeholder="IP:porta" required />
      <button type="submit">Connetti WebSocket</button>
    </form>
    <div id="status" class="status" style="display: none;">Connesso!</div>
  </header>

  <main>
    <div class="left">
      <canvas id="chart"></canvas>
      <div class="telemetry" id="telemetry">In attesa di connessione...</div>
    </div>

    <div class="right">
      <div>VelocitÃ  Corrente</div>
      <div class="speed-display" id="speedDisplay">-- km/h</div>
    </div>
  </main>

  <div class="strategy-section">
    <h2>Strategia di Gara</h2>
    <div class="strategy-grid">
      <div>
        <p><strong>Giro previsto pit stop:</strong> <span id="pitLap">--</span></p>
        <p><strong>Posizione al rientro:</strong> <span id="rejoinPos">--</span></p>
        <p><strong>Consumo gomme:</strong> <span id="tyreWear">--%</span></p>
      </div>
      <div>
        <p><strong>Media tempi giro:</strong> <span id="avgLapTime">--</span></p>
        <p><strong>Miglior giro:</strong> <span id="fastestLap">--</span></p>
        <p><strong>Passo leader:</strong> <span id="leaderPace">--</span></p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const telemetry = document.getElementById('telemetry');
      const form = document.getElementById('configForm');
      const ipInput = document.getElementById('ipInput');
      const speedDisplay = document.getElementById('speedDisplay');
      const statusEl = document.getElementById('status');

      const elements = {
        pitLap: document.getElementById('pitLap'),
        rejoinPos: document.getElementById('rejoinPos'),
        tyreWear: document.getElementById('tyreWear'),
        avgLapTime: document.getElementById('avgLapTime'),
        fastestLap: document.getElementById('fastestLap'),
        leaderPace: document.getElementById('leaderPace')
      };

      if (!document.getElementById('chart')) {
        telemetry.textContent = 'Errore: Canvas #chart mancante!';
        return;
      }

      let socket;
      let chart;
      const MAX_POINTS = 50;
      const labels = [];
      const speedData = [];
      const throttleData = [];
      const brakeData = [];

      // Inizializza Chart
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'VelocitÃ  (km/h)', data: speedData, borderColor: 'lime', yAxisID: 'y', fill: false, tension: 0.4 },
            { label: 'Throttle (%)', data: throttleData, borderColor: 'cyan', yAxisID: 'y1', fill: false, tension: 0.4 },
            { label: 'Freno (%)', data: brakeData, borderColor: 'red', yAxisID: 'y1', fill: false, tension: 0.4 }
          ]
        },
        options: {
          responsive: true,
          interaction: { intersect: false },
          plugins: {
            legend: { labels: { color: 'white' } }
          },
          scales: {
            x: { ticks: { color: 'white' }, grid: { color: '#444' } },
            y: { type: 'linear', position: 'left', beginAtZero: true, max: 350, ticks: { color: 'lime' }, grid: { color: '#444' } },
            y1: { type: 'linear', position: 'right', beginAtZero: true, max: 100, ticks: { color: 'cyan' }, grid: { drawOnChartArea: false } }
          }
        }
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const ip = ipInput.value.trim();
        if (!ip) return;

        if (socket) socket.close();

        statusEl.style.display = 'none';
        telemetry.innerHTML = 'Connessione in corso...';
        speedDisplay.textContent = '-- km/h';

        socket = new WebSocket(`ws://${ip}:3000`);

        socket.onopen = () => {
          statusEl.style.display = 'block';
          telemetry.innerHTML = 'Connesso! In attesa dati...';
        };

        socket.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            telemetry.innerHTML = `Throttle: ${data.throttle ?? 0}% | Freno: ${data.brake ?? 0}%`;
            speedDisplay.textContent = `${data.speed ?? 0} km/h`;

            // Aggiorna strategia
            Object.entries(elements).forEach(([key, el]) => {
              el.textContent = data[key] ?? '--';
            });

            // Aggiorna grafico
            const now = new Date().toLocaleTimeString();
            labels.push(now);
            speedData.push(data.speed ?? 0);
            throttleData.push(data.throttle ?? 0);
            brakeData.push(data.brake ?? 0);

            if (labels.length > MAX_POINTS) {
              labels.shift();
              speedData.shift();
              throttleData.shift();
              brakeData.shift();
            }

            chart.update('none');
          } catch (err) {
            console.error('Errore JSON:', err);
            telemetry.innerHTML = 'Dati invalidi ricevuti.';
          }
        };

        socket.onerror = (err) => {
          console.error('WS errore:', err);
          telemetry.innerHTML = 'âŒ Errore connessione WebSocket.';
          speedDisplay.textContent = '-- km/h';
          statusEl.style.display = 'none';
        };

        socket.onclose = (event) => {
          console.log('WS chiuso:', event.code, event.reason);
          telemetry.innerHTML = 'ðŸ”Œ Connessione chiusa. Riprova.';
          speedDisplay.textContent = '-- km/h';
          statusEl.style.display = 'none';
        };
      });
    });
  </script>
</body>
</html>
